#!/bin/bash

set -e

### === LOG ===
LOG_FILE="install-$(date +%Y%m%d_%H%M%S).log"
exec > >(tee -i "$LOG_FILE")
exec 2>&1

### === CONFIG ===
REPO_DIR="$(pwd)"
USER_HOME="$HOME"

### === SUDO ===
echo "\n[+] Requesting sudo permissions..."
sudo -v

while true; do
    sudo -v
    sleep 60
    kill -0 "$$" || exit
done 2>/dev/null &

### === INSTALLATION STEPS ===
echo "\n[+] Updating system..."
sudo pacman -Syu --noconfirm
echo "[✓] System update complete."

if ! grep -q "^\[multilib\]" /etc/pacman.conf; then
    echo "\n[+] Enabling multilib repository..."
    sudo sed -i '/\[multilib\]/,/Include/s/^#//' /etc/pacman.conf
    sudo pacman -Sy --noconfirm
    echo "[✓] multilib enabled"
else
    echo "[✓] multilib already enabled"
fi

echo "\n[+] Installing base dependencies..."
KERNEL_PKG=$(pacman -Q | grep -E '^linux(-lts|-zen)? ' | awk '{print $1}')
sudo pacman -S --needed --noconfirm \
    git base-devel "${KERNEL_PKG}-headers" curl wget unzip vim \
    pciutils brightnessctl rsync lua python jq
echo "[✓] Base dependencies installation complete."

### === AUR HELPER INSTALLATION ===
if ! command -v yay &>/dev/null; then
    echo "\n[+] Installing YAY AUR helper..."
    git clone https://aur.archlinux.org/yay.git /tmp/yay
    cd /tmp/yay
    makepkg -si --noconfirm
    cd "$REPO_DIR"
    echo "[✓] YAY installation complete."
else
    echo "[✓] YAY is already installed."
fi

### === GPU DRIVERS ===
echo "\n[+] Detecting GPU..."
GPU_INFO=$(sudo lspci | grep -E "VGA|3D" || true)

if echo "$GPU_INFO" | grep -qi intel; then
    echo "[✓] Intel GPU detected"
    sudo pacman -S --needed --noconfirm \
    mesa intel-media-driver libva libva-intel-driver vulkan-intel
fi

if echo "$GPU_INFO" | grep -qi amd; then
    echo "[✓] AMD GPU detected"
    sudo pacman -S --needed --noconfirm \
    mesa xf86-video-amdgpu libva-mesa-driver vulkan-radeon
fi

if echo "$GPU_INFO" | grep -qi nvidia; then
    echo "[✓] NVIDIA GPU detected"
    sudo pacman -S --needed --noconfirm \
    nvidia-open-dkms nvidia-utils lib32-nvidia-utils nvidia-settings egl-wayland

    echo "\n[+] Configuring NVIDIA for Wayland..."
    echo "options nvidia_drm modeset=1" | sudo tee /etc/modprobe.d/nvidia.conf >/dev/null
    sudo modprobe nvidia_drm || true
    echo "[✓] NVIDIA configuration complete."
else
    echo "[✓] No GPU detected."
fi

### === PACKAGES ===
echo "\n[+] Installing packages..."
PACKAGE_LIST="packages.txt"

if [ -f "$PACKAGE_LIST" ]; then
    grep -Ev '^\s*#|^\s*$' "$PACKAGE_LIST" | sed 's/#.*//' | xargs yay -S --needed --noconfirm
    echo "[✓] Package installation complete."
else
    echo "[!] Package list file '$PACKAGE_LIST' not found!"
fi

### === ZSH INSTALLATION ===
echo "\n[+] Installing Zsh and setting it as default shell..."
sudo pacman -S --needed --noconfirm zsh
chsh_path=$(which zsh)
chsh -s "$chsh_path" "$USER"
echo "[✓] Zsh installation and default shell change complete."

### === SERVICES ===
echo "\n[+] Installing service packages..."
sudo pacman -S --needed --noconfirm \
    networkmanager network-manager-applet \
    bluez bluez-utils \
    pipewire pipewire-pulse wireplumber pavucontrol
echo "[✓] Service packages installation complete."

echo "\n[+] Enabling services..."
sudo systemctl enable --now NetworkManager
sudo systemctl enable --now bluetooth
systemctl --user enable --now pipewire pipewire-pulse wireplumber
echo "[✓] Services installation and enabling complete."

### === DOTFILES ===
echo "\n[+] Installing dotfiles..."

# Create necessary directories
mkdir -p "$USER_HOME/.config"
mkdir -p "$USER_HOME/.local/bin" "$USER_HOME/.local/share"

# Home files
if [ -d "dotfiles/home" ]; then
    echo "\n[+] Syncing home directory files..."
    rsync -av dotfiles/home/ "$USER_HOME/"
    echo "[✓] Home files sync complete."
else
    echo "[!] 'dotfiles/home' directory not found, skipping home files sync."
fi

# Config files
if [ -d "dotfiles/config" ]; then
    echo "\n[+] Syncing config directory files..."
    for folder in dotfiles/config/*; do
        app=$(basename "$folder")
        rsync -av --ignore-existing "$folder/" "$USER_HOME/.config/$app/"
    done
    echo "[✓] Config files sync complete."
else
    echo "[!] 'dotfiles/config' directory not found, skipping config files sync."
fi

# Local files
if [ -d "dotfiles/local" ]; then
    echo "\n[+] Syncing local directory files..."
    for folder in dotfiles/local/*; do
        app=$(basename "$folder")
        rsync -av --ignore-existing "$folder/" "$USER_HOME/.local/$app/"
    done
    echo "[✓] Local files sync complete."
else
    echo "[!] 'dotfiles/local' directory not found, skipping local files sync."
fi

echo "[✓] Dotfiles installation complete."

### === DIRECTORIES ===
echo "\n[+] Creating user directories..."
mkdir -p "$USER_HOME/Documents" "$USER_HOME/Downloads" "$USER_HOME/Images" "$USER_HOME/Videos" "$USER_HOME/Music"

### === HYPRLAND KEYBOARD ===
echo "\n[+] Setting up Hyprland keyboard configuration..."
CURRENT_LAYOUT=$(localectl status | grep "X11 Layout" | awk -F: '{print $2}' | xargs)
CURRENT_LAYOUT=${CURRENT_LAYOUT:-"us"}
HYPR_CONFIG="$USER_HOME/.config/hypr/hyprland.conf"

if [ -f "$HYPR_CONFIG" ]; then
    # Remove existing input block if present
    sed -i "/^input {/,/^}/d" "$HYPR_CONFIG"

    # Append new input block
    cat <<EOF >> "$HYPR_CONFIG"
input {
    kb_layout = $CURRENT_LAYOUT
}
EOF

    echo "[✓] Hyprland keyboard layout set to '$CURRENT_LAYOUT'."
else
    echo "[!] Hyprland configuration file not found at '$HYPR_CONFIG'. Skipping keyboard setup."
fi

### === FINALIZATION ===
echo "\n[+] Cleaning up..."
sudo pacman -Sc --noconfirm
yay -Sc --noconfirm
rm -rf /tmp/yay
rm -rf "$USER_HOME/.cache/"* 2>/dev/null || true
echo "[✓] Cleanup completed"

### === DONE ===
which sddm &>/dev/null
if command -v sddm &>/dev/null; then
    echo "\n[+] Enabling SDDM display manager..."
    sudo systemctl enable sddm
    echo "[✓] SDDM enabled."
else
    echo "[!] SDDM not installed, skipping enabling."
fi

echo "[✓] Installation complete! Please reboot your system."
