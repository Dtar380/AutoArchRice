#!/bin/bash

set -e

### === LOG ===
LOG_FILE="install-$(date +%Y%m%d_%H%M%S).log"
exec > >(tee -i "$LOG_FILE")
exec 2>&1

### === CONFIG ===
REPO_DIR="$(pwd)"
USER_HOME="$HOME"

### === SUDO ===
echo "[+] Requesting sudo permissions..."
sudo -v

while true; do
    sudo -n true
    sleep 60
    kill -0 "$$" || exit
done 2>/dev/null &

### === INSTALLATION STEPS ===
echo "[+] Updating system..."
sudo pacman -Syu --noconfirm
echo "[✓] System update complete."

if ! grep -q "^\[multilib\]" /etc/pacman.conf; then
    echo "[+] Enabling multilib repository..."
    sudo sed -i '/\[multilib\]/,/Include/s/^#//' /etc/pacman.conf
    sudo pacman -Sy --noconfirm
    echo "[✓] multilib enabled"
else
    echo "[✓] multilib already enabled"
fi

echo "[+] Installing base dependencies..."
KERNEL_PKG=$(pacman -Q | grep -E '^linux(-lts|-zen)? ' | awk '{print $1}')
sudo pacman -S --needed --noconfirm \
    git base-devel "${KERNEL_PKG}-headers" curl wget unzip vim pciutils brightnessctl
echo "[✓] Base dependencies installation complete."

### === AUR HELPER INSTALLATION ===
if ! command -v yay &>/dev/null; then
    echo "[+] Installing YAY AUR helper..."
    git clone https://aur.archlinux.org/yay.git /tmp/yay
    cd /tmp/yay
    makepkg -si --noconfirm
    cd "$REPO_DIR"
    echo "[✓] YAY installation complete."
else
    echo "[✓] YAY is already installed."
fi

### === GPU DRIVERS ===
echo "[+] Detecting GPU..."
GPU_INFO=$(lspci | grep -E "VGA|3D")

if echo "$GPU_INFO" | grep -qi intel; then
    echo "[✓] Intel GPU detected"
    sudo pacman -S --needed --noconfirm \
    mesa intel-media-driver libva libva-intel-driver vulkan-intel
fi

if echo "$GPU_INFO" | grep -qi amd; then
    echo "[✓] AMD GPU detected"
    sudo pacman -S --needed --noconfirm \
    mesa xf86-video-amdgpu libva-mesa-driver vulkan-radeon
fi

if echo "$GPU_INFO" | grep -qi nvidia; then
    echo "[✓] NVIDIA GPU detected"
    sudo pacman -S --needed --noconfirm \
    nvidia-open-dkms nvidia-utils lib32-nvidia-utils nvidia-settings egl-wayland

    echo "[+] Configuring NVIDIA for Wayland..."
    echo "options nvidia_drm modeset=1" | sudo tee /etc/modprobe.d/nvidia.conf >/dev/null
    sudo modprobe nvidia_drm || true
    echo "[✓] NVIDIA configuration complete."
fi

### === PACKAGES ===
echo "[+] Installing packages..."
PACKAGE_LIST="packages.txt"

if [ -f "$PACKAGE_LIST" ]; then
    grep -Ev '^\s*#|^\s*$' "$PACKAGE_LIST" | yay -S --needed --noconfirm -
    echo "[✓] Package installation complete."
else
    echo "[!] Package list file '$PACKAGE_LIST' not found!"
fi

### === SERVICES ===
echo "[+] Installing service packages..."
sudo pacman -S --needed --noconfirm \
    NetworkManager network-manager-applet \
    bluez bluez-utils \
    pipewire pipewire-pulse wireplumber pavucontrol
echo "[✓] Service packages installation complete."

echo "[+] Enabling services..."
sudo systemctl enable --now NetworkManager
sudo systemctl enable --now bluetooth
systemctl --user enable --now pipewire pipewire-pulse wireplumber
echo "[✓] Services installation and enabling complete."

### === DOTFILES ===
echo "[+] Installing dotfiles..."

# Create necessary directories
mkdir -p "$USER_HOME/.config"
mkdir -p "$USER_HOME/.local/bin" "$USER_HOME/.local/share"

# Home files
rsync -av dotfiles/home/ "$USER_HOME/"

# Config files
for folder in dotfiles/config/*; do
    app=$(basename "$folder")
    rsync -av --ignore-existing "$folder/" "$USER_HOME/.config/$app/"
done

# Local files
for folder in dotfiles/local/*; do
    app=$(basename "$folder")
    rsync -av --ignore-existing "$folder/" "$USER_HOME/.local/$app/"
done

echo "[✓] Dotfiles installation complete."

### === DIRECTORIES ===
echo "[+] Creating user directories..."
mkdir -p "$USER_HOME/Documents" "$USER_HOME/Downloads" "$USER_HOME/Images" "$USER_HOME/Videos" "$USER_HOME/Music"

### === FINALIZATION ===
echo "[+] Cleaning up..."
sudo pacman -Sc --noconfirm
yay -Sc --noconfirm
rm -rf /tmp/yay
rm -rf "$USER_HOME/.cache/"{*,.*} 2>/dev/null || true
echo "[✓] Cleanup completed"

echo "[✓] Installation complete! Please reboot your system."
